<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=59770&amp;path=livereload" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="The BSD Packet Filter (BPF) Paper">
<title>The BSD Packet Filter (BPF) Paper</title>

<link rel='canonical' href='http://localhost:59770/p/the-bsd-packet-filter-bpf-paper/'>

<link rel="stylesheet" href="/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="The BSD Packet Filter (BPF) Paper">
<meta property='og:description' content="The BSD Packet Filter (BPF) Paper">
<meta property='og:url' content='http://localhost:59770/p/the-bsd-packet-filter-bpf-paper/'>
<meta property='og:site_name' content='GreyWind'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='bpf' /><meta property='article:published_time' content='2024-09-17T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2024-09-17T00:00:00&#43;00:00'/>
<meta name="twitter:title" content="The BSD Packet Filter (BPF) Paper">
<meta name="twitter:description" content="The BSD Packet Filter (BPF) Paper">
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu_dca9491aad8d3457.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">üç•</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">GreyWind</a></h1>
            <h2 class="site-description">Do one thing and do it well.</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/fuwx295'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg t="1740911471151" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5331" id="mx_n_1740911471153" width="24" height="24" xmlns:xlink="http://www.w3.org/1999/xlink">
<path d="M679.834025 1019.751037c-25.493776 0-42.489627-16.995851-42.489627-42.489626v-165.709544c0-33.991701-8.497925-59.485477-29.742738-80.73029-12.746888-12.746888-16.995851-29.742739-8.497926-42.489627 8.497925-12.746888 21.244813-25.493776 33.991702-29.742738 123.219917-12.746888 237.941909-55.236515 237.941908-254.93776s-16.995851-93.477178-50.987551-131.717842c-12.746888-12.746888-12.746888-29.742739-8.497926-42.489627 12.746888-33.991701 12.746888-67.983402 4.248963-101.975103-21.244813 4.248963-55.236515 16.995851-110.473029 55.236514-8.497925 8.497925-21.244813 8.497925-33.991701 4.248963-89.228216-25.493776-186.954357-25.493776-276.182573 0-12.746888 0-25.493776 0-33.991701-4.248963C305.925311 144.46473 267.684647 131.717842 250.688797 127.46888c-8.497925 33.991701-4.248963 67.983402 4.248962 101.975103 4.248963 16.995851 0 33.991701-8.497925 42.489627-33.991701 33.991701-50.987552 80.73029-50.987552 131.717842 0 199.701245 114.721992 242.190871 237.941909 254.93776 16.995851 0 29.742739 12.746888 33.991701 29.742738 4.248963 16.995851 0 33.991701-8.497925 42.489627-21.244813 21.244813-29.742739 46.738589-29.742739 76.481328v165.709543c0 25.493776-16.995851 42.489627-42.489626 42.489627s-42.489627-16.995851-42.489627-42.489627v-72.232365c-127.46888 21.244813-182.705394-50.987552-220.946058-97.726141-16.995851-21.244813-29.742739-38.240664-46.738589-42.489627-21.244813-4.248963-38.240664-29.742739-29.742739-50.987552 4.248963-21.244813 29.742739-38.240664 50.987552-29.742738 42.489627 12.746888 67.983402 42.489627 93.477179 72.232365 33.991701 46.738589 63.73444 80.73029 152.962655 63.73444 0-29.742739 0-59.485477 12.746888-80.730291-118.970954-25.493776-246.439834-101.975104-246.439834-327.170124 0-63.73444 21.244813-123.219917 59.485477-169.958506-12.746888-55.236515-8.497925-114.721992 12.746888-165.709544 4.248963-12.746888 12.746888-21.244813 25.493776-25.493776 16.995851-4.248963 72.232365-12.746888 186.954357 59.485477 93.477178-21.244813 191.20332-21.244813 280.431535 0 110.473029-72.232365 169.958506-63.73444 186.954357-59.485477 12.746888 0 21.244813 12.746888 25.493776 25.493776 21.244813 55.236515 25.493776 110.473029 12.746888 165.709544 38.240664 46.738589 59.485477 106.224066 59.485477 169.958506 0 242.190871-144.46473 305.925311-246.439834 331.419087 8.497925 25.493776 12.746888 55.236515 12.746888 80.730291v161.46058c0 25.493776-16.995851 42.489627-42.489626 42.489627L679.834025 1019.751037z" fill="currentColor" p-id="5332"></path>
</svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://x.com/GreyWind2077'
                        target="_blank"
                        title="X"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg t="1740911581981" class="icon" viewBox="0 0 1088 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8935" xmlns:xlink="http://www.w3.org/1999/xlink" width="25.5" height="24">
<path d="M647.488 433.344L1052.544 0h-96L604.864 376.32 323.968 0H0l424.768 568.96L0 1023.552h96l371.392-397.44 296.64 397.44H1088l-440.512-590.08zM516.032 574.08l-43.008-56.64-342.4-450.88h147.392l276.352 363.904 43.008 56.64L956.608 960h-147.456l-293.12-385.92z" fill="currentColor" p-id="8936"></path>
</svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='mailto:f2928560492@gmail.com'
                        target="_blank"
                        title="Email"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1740916044811" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11060" xmlns:xlink="http://www.w3.org/1999/xlink" width="24" height="24"><path d="M815.25 80.23h-606.9c-111.86 0-202.87 91-202.87 202.88v470C5.48 865 96.5 956 208.35 956h606.89c111.87 0 202.88-91 202.88-202.88v-470c0.01-111.89-91-202.89-202.87-202.89zM706.43 449.74l213.14-229.11c11.03 18.34 17.76 39.56 17.76 62.49v379.13l-230.9-212.51z m108.82-288.71c14.84 0 28.89 3.05 42.06 7.92L511.79 540.34 166.3 168.95c13.17-4.87 27.22-7.92 42.05-7.92h606.9z m-711.21 59.6l213.13 229.11L86.28 662.25V283.12c0-22.92 6.73-44.15 17.76-62.49zM815.25 875.2h-606.9c-61.39 0-111.83-45.69-120.33-104.78l284.16-261.54 139.6 150.07L651.4 508.88l284.18 261.54c-8.5 59.09-58.95 104.78-120.33 104.78z" fill="currentColor" p-id="11061"></path></svg>
                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#architecture">Architecture</a></li>
    <li><a href="#performance">Performance</a></li>
    <li><a href="#why-bpf-faster">Why BPF faster?</a></li>
    <li><a href="#bpf-vm">BPF VM</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/the-bsd-packet-filter-bpf-paper/">The BSD Packet Filter (BPF) Paper</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            The BSD Packet Filter (BPF) Paper
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Sep 17, 2024</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    4 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="introduction">Introduction
</h2><p><a class="link" href="https://www.tcpdump.org/papers/bpf-usenix93.pdf"  target="_blank" rel="noopener"
    >The BSD Packet Filter: A New Architecture for User-level Packet Capture</a> Paper is published by UCB in Winter USENIX 1992.</p>
<p>The BPF as known as BSD Packet Filter. It provides a raw interface to data link layers, permitting raw link-layer packets to be send and received, and allow a <code>user-space</code> process to supply a filter program that specifies which packets it wants to receive. For example <code>TCPDUMP</code>, which directly filters incoming packets in the kernel based on <code>user-space</code> rules.</p>
<h2 id="architecture">Architecture
</h2><p><img src="/p/the-bsd-packet-filter-bpf-paper/bpf_overview.png"
	width="787"
	height="687"
	srcset="/p/the-bsd-packet-filter-bpf-paper/bpf_overview_hu_ea13228318372a7e.png 480w, /p/the-bsd-packet-filter-bpf-paper/bpf_overview_hu_393922de5ef4c41a.png 1024w"
	loading="lazy"
	
		alt="bpf_overview"
	
	
		class="gallery-image" 
		data-flex-grow="114"
		data-flex-basis="274px"
	
></p>
<p>BPF has tow components:</p>
<ul>
<li>
<p>the network tap (Collect packet)</p>
</li>
<li>
<p>the packet filter (filter packet by rule)</p>
</li>
</ul>
<ol>
<li>
<p>When Received Packet, link-level driver will not only send to the protocol stack, but also to the BPF, which will filter it.</p>
</li>
<li>
<p>BPF according to different filters, won‚Äôt copy it to other buffers in the kernel and then process it. Only after processing the packet, it will copy into a buffer that the user-space can get.</p>
</li>
<li>
<p>When processing the packet int BPF, it is not processing one by one. Because the time interval between receiving packets is too short, and the use of the read <code>syscall</code> is very laborious. BPF packages the data for analysis, and in order to distinguish this data, BPF adds a layer of header, which is used as the boundary of the data.</p>
</li>
</ol>
<h2 id="performance">Performance
</h2><p>The performance of BPF and NIT (another packet filter) is compared for two extreme cases, in which all packets are received and all packets are rejected.</p>
<p><img src="/p/the-bsd-packet-filter-bpf-paper/bpf_exp1.png"
	width="930"
	height="651"
	srcset="/p/the-bsd-packet-filter-bpf-paper/bpf_exp1_hu_f177383e8e544ddb.png 480w, /p/the-bsd-packet-filter-bpf-paper/bpf_exp1_hu_bb8b31f0d5b00673.png 1024w"
	loading="lazy"
	
		alt="bpf_exp1"
	
	
		class="gallery-image" 
		data-flex-grow="142"
		data-flex-basis="342px"
	
></p>
<p><img src="/p/the-bsd-packet-filter-bpf-paper/bpf_exp2.png"
	width="909"
	height="648"
	srcset="/p/the-bsd-packet-filter-bpf-paper/bpf_exp2_hu_bae2ffa0af43052b.png 480w, /p/the-bsd-packet-filter-bpf-paper/bpf_exp2_hu_1a141d2a1e78c210.png 1024w"
	loading="lazy"
	
		alt="bpf_exp2"
	
	
		class="gallery-image" 
		data-flex-grow="140"
		data-flex-basis="336px"
	
></p>
<ul>
<li>
<p>X axis is the Packet Size, Y axis is the average process time. When X axis is zero, Y axis value is the overhead of calling filter per packet.</p>
</li>
<li>
<p>Due to allocate and initialize the buffer, the NIT need <code>80-100ms</code>, BPF only need <code>5ms</code></p>
</li>
<li>
<p>As the packet size increases, it can be seen that when <code>accepting all packets</code>, although all packets are copied into the buffer, BPF is faster. When <code>rejecting all packets</code>, since BPF directly filters out all packets without any copying, its overhead is almost constant, i.e., the overhead of the filter call.</p>
</li>
</ul>
<p>In network monitoring, more information is generally discarded than is needed, so the BPF performance advantage is huge.</p>
<h2 id="why-bpf-faster">Why BPF faster?
</h2><p>A filter is like an assertion, either true or false, about whether the package is needed filter.</p>
<p><img src="/p/the-bsd-packet-filter-bpf-paper/bpf_tree.png"
	width="738"
	height="280"
	srcset="/p/the-bsd-packet-filter-bpf-paper/bpf_tree_hu_51913544bd75093b.png 480w, /p/the-bsd-packet-filter-bpf-paper/bpf_tree_hu_954cea58089509ae.png 1024w"
	loading="lazy"
	
		alt="bpf_tree"
	
	
		class="gallery-image" 
		data-flex-grow="263"
		data-flex-basis="632px"
	
></p>
<ul>
<li>
<p>CSPF uses the <strong>tree structure</strong>, which has the advantage of being simple to implement. However, traversing the tree requires the use of a stack, and every time you push a constant or packet of data into the stack, you need to perform a binary operation between the two elements at the top of the stack. After running through the entire tree structure, the top element of the stack is then read and the packet is only received if it is a non-zero value or the stack is empty, otherwise it is discarded.</p>
</li>
<li>
<p>Even if you can use the short-circuit operation to optimize the implementation code, there is still a big problem, first of all, <strong>the network is hierarchical, there are many first parts in the packet structure, nested layer by layer, every time you make a judgment to re-disassemble the packet.</strong></p>
</li>
<li>
<p>Secondly, the reception is also to <strong>receive a whole packet, without considering that there will be a lot of unwanted data</strong>, which is obviously less efficient than BPF.</p>
</li>
</ul>
<p><img src="/p/the-bsd-packet-filter-bpf-paper/bpf_cfg.png"
	width="424"
	height="438"
	srcset="/p/the-bsd-packet-filter-bpf-paper/bpf_cfg_hu_19d822c3b947193e.png 480w, /p/the-bsd-packet-filter-bpf-paper/bpf_cfg_hu_57ec0f535e9246c4.png 1024w"
	loading="lazy"
	
		alt="bpf_cfg"
	
	
		class="gallery-image" 
		data-flex-grow="96"
		data-flex-basis="232px"
	
></p>
<p>BPF uses a CFG (Control Flow Graph), which is a DAG (Directed Acyclic Graph).The left branch indicates that the node is false and the right branch indicates that the node is true. <strong>this structure makes more use of registers, which is also a reason for being faster.</strong></p>
<h2 id="bpf-vm">BPF VM
</h2><p><img src="/p/the-bsd-packet-filter-bpf-paper/bpf_op.png"
	width="235"
	height="83"
	srcset="/p/the-bsd-packet-filter-bpf-paper/bpf_op_hu_62f35737b5c5207d.png 480w, /p/the-bsd-packet-filter-bpf-paper/bpf_op_hu_6d4775b6b389858c.png 1024w"
	loading="lazy"
	
		alt="bpf_op"
	
	
		class="gallery-image" 
		data-flex-grow="283"
		data-flex-basis="679px"
	
></p>
<p><img src="/p/the-bsd-packet-filter-bpf-paper/bpf_instruct.png"
	width="409"
	height="558"
	srcset="/p/the-bsd-packet-filter-bpf-paper/bpf_instruct_hu_1a864be5ed373bf4.png 480w, /p/the-bsd-packet-filter-bpf-paper/bpf_instruct_hu_68b9b0f586874769.png 1024w"
	loading="lazy"
	
		alt="bpf_instruct"
	
	
		class="gallery-image" 
		data-flex-grow="73"
		data-flex-basis="175px"
	
></p>
<p><img src="/p/the-bsd-packet-filter-bpf-paper/bpf_address.png"
	width="452"
	height="386"
	srcset="/p/the-bsd-packet-filter-bpf-paper/bpf_address_hu_f7dc99655b9bfd44.png 480w, /p/the-bsd-packet-filter-bpf-paper/bpf_address_hu_ffa66c333a0fd333.png 1024w"
	loading="lazy"
	
		alt="bpf_addressing_modes"
	
	
		class="gallery-image" 
		data-flex-grow="117"
		data-flex-basis="281px"
	
></p>
<p>In order to realize the above functions, BPF has <strong>designed a virtual machine in the kernel</strong>, which uses mostly binary, single-address arithmetic.</p>
<p>It also defines a series of 32-bit arithmetic instructions as follows, but they are implemented as macros, and in the paper they are in assembly form for ease of reading.</p>
<p>Notice that a lot of the addressing operations are relative to packages, since this virtual machine is used to analyze packages.</p>
<p><img src="/p/the-bsd-packet-filter-bpf-paper/bpf_cmd.png"
	width="191"
	height="160"
	srcset="/p/the-bsd-packet-filter-bpf-paper/bpf_cmd_hu_43a3c8d98cae500b.png 480w, /p/the-bsd-packet-filter-bpf-paper/bpf_cmd_hu_29c5db2b9da4970.png 1024w"
	loading="lazy"
	
		alt="bpf_cmd"
	
	
		class="gallery-image" 
		data-flex-grow="119"
		data-flex-basis="286px"
	
></p>
<p>Since the data is not fixed in the packet, BPF defines an operation to simplify the steps of address operation, i.e., <code>4\*(\[14\]&amp;0xf)</code>, which actually <strong>analyzes the IP header</strong>, multiplied by 4 because offset is the unit of word length, which is 4 bytes.</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/bpf/">Bpf</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

     
    
        
    <script src='//unpkg.com/@waline/client@v2/dist/waline.js'></script>
<link href='//unpkg.com/@waline/client@v2/dist/waline.css' rel='stylesheet'/>
<div id="waline" class="waline-container"></div>
<style>
    .waline-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
        --waline-font-size: var(--article-font-size);
    }
    .waline-container .wl-count {
        color: var(--card-text-color-main);
    }
</style><script>
    
    Waline.init({"dark":"html[data-scheme=\"dark\"]","el":"#waline","emoji":["https://npm.elemecdn.com/@waline/emojis@1.1.0/bilibili","https://npm.elemecdn.com/@waline/emojis@1.1.0/bmoji","https://npm.elemecdn.com/@waline/emojis@1.1.0/weibo"],"lang":"zh-CN","locale":{"admin":"Admin","placeholder":"Ê¨¢ËøéÁïô‰∏ãÂÆùË¥µÁöÑËØÑËÆ∫!"},"pageview":true,"requiredMeta":["name","email","url"],"serverURL":"https://waline-drab-three.vercel.app/"});
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2023 - 
        
        2025 GreyWind
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.cf4a995d396158b81f16c3d1a4c0e65d7051a35d12534c905d216887ca4b8b76.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
